<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>IMU SBOM Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{font-family:system-ui,sans-serif;background:#0b1020;color:#e6edf3;margin:0}
header{padding:10px 14px;background:#11162a;border-bottom:1px solid #1f2a44;display:flex;align-items:center;gap:10px}
.badge{background:#243152;border:1px solid #355;color:#9fb7ff;border-radius:999px;padding:2px 8px;font-size:12px}
main{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
.card{background:#12172d;border:1px solid #233259;border-radius:10px;padding:12px}
label{display:block;font-size:12px;color:#9fb7ff}
input,button{background:#0e1630;border:1px solid #233259;color:#e6edf3;border-radius:8px;padding:6px 8px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #233259;padding:6px 8px;font-size:12px}
small{color:#9fb7ff}
pre{background:#0e1630;border:1px solid #233259;border-radius:8px;padding:8px;overflow:auto}
</style>
</head>
<body>
<header>
  <strong>IMU SBOM Viewer</strong>
  <a class="badge" href="/ui/index.html" style="text-decoration:none">‚Üê back</a>
</header>
<main>
  <div class="card">
    <h3>Load SBOM</h3>
    <label>SBOM file path (CycloneDX JSON)</label>
    <input id="sbom_path" value="/mnt/data/imu_repo/sbom/cyclonedx_demo.json"/>
    <div style="margin-top:8px"><button id="btn_load">Load</button></div>
    <div style="margin-top:16px">
      <h4>Attest SBOM (cosign keyless)</h4>
      <label>Image</label>
      <input id="image" value="nginx:alpine"/>
      <div style="margin-top:8px"><button id="btn_attest">Attest</button></div>
      <pre id="attest_out"></pre>
    </div>
  </div>

  <div class="card">
    <h3>Summary</h3>
    <div id="summary"></div>
    <h3>Components</h3>
    <table id="tbl"><thead><tr><th>type</th><th>name</th><th>version</th><th>purl</th><th>license</th></tr></thead><tbody></tbody></table>
    <h3>Raw</h3>
    <pre id="raw"></pre>
  </div>
</main>
<script>
const $=s=>document.querySelector(s);

function setSummary(bom){
  const app = bom?.metadata?.component||{};
  $("#summary").innerHTML = `<div><b>App:</b> ${app.name||'-'} ${app.version||''}</div>
  <div><b>Spec:</b> ${bom?.specVersion||'-'}</div>
  <div><b>Generated:</b> ${bom?.metadata?.timestamp||'-'}</div>`;
}

function setComponents(bom){
  const tb = $("#tbl tbody"); tb.innerHTML='';
  for(const c of (bom.components||[])){
    const lic = (c.licenses||[])[0]?.license?.id || (c.licenses||[])[0]?.license?.name || '';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.type||''}</td><td>${c.name||''}</td><td>${c.version||''}</td><td>${c.purl||''}</td><td>${lic}</td>`;
    tb.appendChild(tr);
  }
}

$("#btn_load").onclick=async()=>{
  try{
    const fp=$("#sbom_path").value;
    const r=await fetch(fp); const bom=await r.json();
    $("#raw").textContent = JSON.stringify(bom,null,2);
    setSummary(bom); setComponents(bom);
  }catch(e){
    $("#raw").textContent = "Failed to load: "+e;
  }
};

$("#btn_attest").onclick=async()=>{
  const img=$("#image").value;
  const fp=$("#sbom_path").value;
  const r=await fetch('/supplychain/index/attest',{method:'POST',headers:{'content-type':'application/json'},
    body: JSON.stringify({image:img, predicate_path:fp})
  });
  const j=await r.json();
  $("#attest_out").textContent = JSON.stringify(j,null,2);
};
</script>
</body>
</html>