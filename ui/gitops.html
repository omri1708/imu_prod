<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>IMU GitOps</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{font-family:system-ui,sans-serif;background:#0b1020;color:#e6edf3;margin:0}
header{padding:10px 14px;background:#11162a;border-bottom:1px solid #1f2a44;display:flex;gap:10px;align-items:center}
.badge{background:#243152;border:1px solid #355;color:#9fb7ff;border-radius:999px;padding:2px 8px;font-size:12px}
main{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px}
.card{background:#12172d;border:1px solid #233259;border-radius:10px;padding:12px}
label{display:block;font-size:12px;color:#9fb7ff}
input,button{background:#0e1630;border:1px solid #233259;color:#e6edf3;border-radius:8px;padding:6px 8px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #233259;padding:6px 8px;font-size:12px}
pre{background:#0e1630;border:1px solid #233259;border-radius:8px;padding:8px;overflow:auto}
</style>
</head>
<body>
<header>
  <strong>IMU GitOps</strong>
  <a class="badge" href="/ui/index.html" style="text-decoration:none">← back</a>
</header>
<main>
  <div class="card">
    <h3>Repo</h3>
    <label>Path</label><input id="repo" value=".imu/gitops/repo"/>
    <div style="margin-top:8px"><button id="btn_init">Init</button></div>
    <pre id="out_init"></pre>

    <h3 style="margin-top:16px">Remote</h3>
    <label>URL</label><input id="remote" placeholder="git@github.com:org/repo.git"/>
    <div style="margin-top:8px"><button id="btn_remote">Set Remote</button></div>
    <pre id="out_remote"></pre>

    <h3 style="margin-top:16px">Branch</h3>
    <label>Name</label><input id="br" value="feature-1"/>
    <div style="margin-top:8px"><button id="btn_branch">Create/Checkout</button></div>
    <pre id="out_branch"></pre>

    <h3 style="margin-top:16px">Commit</h3>
    <label>Message</label><input id="msg" value="update files"/>
    <div style="margin-top:8px"><button id="btn_commit">Commit (add .)</button></div>
    <pre id="out_commit"></pre>

    <h3 style="margin-top:16px">Push</h3>
    <div style="margin-top:8px"><button id="btn_push">Push</button></div>
    <pre id="out_push"></pre>
  </div>

  <div class="card">
    <h3>Pull Requests</h3>
    <div><button id="btn_list">Refresh</button></div>
    <table id="tbl"><thead><tr><th>id</th><th>title</th><th>branch→target</th><th>actions</th></tr></thead><tbody></tbody></table>
    <h4>Open PR</h4>
    <label>Title</label><input id="title" value="Update"/>
    <label>Description</label><input id="desc" value="changes"/>
    <div style="margin-top:8px"><button id="btn_openpr">Open PR</button></div>
    <pre id="out_pr"></pre>
  </div>
</main>
<script>
const $=s=>document.querySelector(s);
async function api(path,method="GET",body=null){
  const r=await fetch(path,{method,headers:{'content-type':'application/json'},body: body?JSON.stringify(body):null});
  const j=await r.json(); if(!r.ok) throw new Error(j.detail||JSON.stringify(j)); return j;
}
$("#btn_init").onclick=async()=>{ const j=await api('/gitops/init','POST',{user_id:'demo-user',path:$("#repo").value}); $("#out_init").textContent=JSON.stringify(j,null,2); };
$("#btn_remote").onclick=async()=>{ const j=await api('/gitops/remote','POST',{user_id:'demo-user',path:$("#repo").value,name:'origin',url:$("#remote").value}); $("#out_remote").textContent=JSON.stringify(j,null,2); };
$("#btn_branch").onclick=async()=>{ const j=await api('/gitops/branch','POST',{user_id:'demo-user',path:$("#repo").value,name:$("#br").value}); $("#out_branch").textContent=JSON.stringify(j,null,2); };
$("#btn_commit").onclick=async()=>{ const j=await api('/gitops/commit','POST',{user_id:'demo-user',path:$("#repo").value,message:$("#msg").value,add_patterns:["."]}); $("#out_commit").textContent=JSON.stringify(j,null,2); };
$("#btn_push").onclick=async()=>{ const j=await api('/gitops/push','POST',{user_id:'demo-user',path:$("#repo").value,remote:'origin'}); $("#out_push").textContent=JSON.stringify(j,null,2); };
$("#btn_openpr").onclick=async()=>{ const j=await api('/gitops/pr/open','POST',{user_id:'demo-user',path:$("#repo").value,branch:$("#br").value,target:'main',title:$("#title").value,description:$("#desc").value}); $("#out_pr").textContent=JSON.stringify(j,null,2); list(); };
$("#btn_list").onclick=list;
async function list(){
  const j=await api('/gitops/pr/list'); const tb=$("#tbl tbody"); tb.innerHTML='';
  (j.items||[]).forEach(pr=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${pr.id}</td><td>${pr.title||''}</td><td>${pr.branch} → ${pr.target}</td>
    <td><button data-id="${pr.id}" class="merge">merge</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button.merge').forEach(b=>{
    b.onclick=async()=>{
      const j=await api('/gitops/pr/merge','POST',{user_id:'demo-user',pr_id:b.dataset.id});
      alert('merged: '+JSON.stringify(j)); list();
    };
  });
}
list();
</script>
</body>
</html>