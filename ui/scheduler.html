<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>IMU Scheduler</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{font-family:system-ui,sans-serif;background:#0b1020;color:#e6edf3;margin:0}
header{padding:10px 14px;background:#11162a;border-bottom:1px solid #1f2a44;display:flex;gap:10px;align-items:center}
.badge{background:#243152;border:1px solid #355;color:#9fb7ff;border-radius:999px;padding:2px 8px;font-size:12px}
main{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px}
.card{background:#12172d;border:1px solid #233259;border-radius:10px;padding:12px}
label{display:block;font-size:12px;color:#9fb7ff}
input,select,button,textarea{background:#0e1630;border:1px solid #233259;color:#e6edf3;border-radius:8px;padding:6px 8px}
textarea{width:100%;height:120px;font-family:ui-monospace,menlo,consolas,monospace}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #233259;padding:6px 8px;font-size:12px}
pre{background:#0e1630;border:1px solid #233259;border-radius:8px;padding:8px;overflow:auto}
</style>
</head>
<body>
<header>
  <strong>IMU Scheduler</strong>
  <a class="badge" href="/ui/index.html" style="text-decoration:none">home</a>
  <button id="btn_start" class="badge">start</button>
  <button id="btn_stop" class="badge">stop</button>
</header>
<main>
  <div class="card">
    <h3>Create</h3>
    <label>Kind</label>
    <select id="kind">
      <option>emit_event</option>
      <option>runbook.unity_k8s</option>
      <option>auto_canary.start</option>
      <option>gatekeeper.evaluate_and_set_status</option>
      <option>supplychain.attest</option>
      <option>unified.export_signed</option>
    </select>
    <label>Mode</label>
    <select id="mode"><option>at</option><option>interval</option></select>
    <label>at_ts (epoch sec)</label><input id="at_ts" placeholder="leave empty for +5s"/>
    <label>interval_s</label><input id="interval_s" placeholder="e.g. 86400 for nightly"/>
    <label>Args (JSON)</label><textarea id="args">{}</textarea>
    <div style="margin-top:8px"><button id="btn_create">Create</button></div>
    <pre id="out_create"></pre>
  </div>

  <div class="card">
    <h3>Schedules</h3>
    <button id="btn_refresh">Refresh</button>
    <table id="tbl"><thead><tr><th>id</th><th>kind</th><th>next</th><th>mode</th><th>disabled</th><th>actions</th></tr></thead><tbody></tbody></table>
    <pre id="out_edit"></pre>
  </div>
</main>
<script>
const $=s=>document.querySelector(s);
async function api(p,m='GET',b=null){ const r=await fetch(p,{method:m,headers:{'content-type':'application/json'},body:b?JSON.stringify(b):null}); const j=await r.json(); if(!r.ok) throw new Error(j.detail||JSON.stringify(j)); return j; }
$("#btn_start").onclick=async()=>{ await api('/scheduler/start','POST'); alert('started'); };
$("#btn_stop").onclick=async()=>{ await api('/scheduler/stop','POST'); alert('stopped'); };
$("#btn_create").onclick=async()=>{
  const body={user_id:'demo-user',kind:$("#kind").value,mode:$("#mode").value,at_ts:parseFloat($("#at_ts").value||"0")||undefined,interval_s:parseFloat($("#interval_s").value||"0")||undefined,args: JSON.parse($("#args").value||"{}")};
  const j=await api('/scheduler/create','POST',body); $("#out_create").textContent=JSON.stringify(j,null,2); load();
};
$("#btn_refresh").onclick=load;
async function load(){
  const j=await api('/scheduler/list'); const tb=$("#tbl tbody"); tb.innerHTML='';
  (j.items||[]).forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.id}</td><td>${it.kind}</td><td>${new Date((it.next_run_ts||0)*1000).toLocaleString()}</td><td>${it.mode}</td><td>${it.disabled}</td>
      <td><button data-id="${it.id}" class="ena">${it.disabled?'enable':'disable'}</button> <button data-id="${it.id}" class="del">delete</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('.ena').forEach(b=>{
    b.onclick=async()=>{ const id=b.dataset.id; const disabled = b.textContent==='disable'; const j=await api('/scheduler/update','POST',{user_id:'demo-user',id,disabled}); $("#out_edit").textContent=JSON.stringify(j,null,2); load(); };
  });
  tb.querySelectorAll('.del').forEach(b=>{
    b.onclick=async()=>{ const id=b.dataset.id; const j=await api('/scheduler/delete','POST',{user_id:'demo-user',id}); $("#out_edit").textContent=JSON.stringify(j,null,2); load(); };
  });
}
load();
</script>
</body>
</html>