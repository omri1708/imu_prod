<!doctype html>
<html lang="he">
<head>
<meta charset="utf-8"/>
<title>IMU Live</title>
<style>
  #timeline { font-family: monospace; max-height: 220px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #eee; padding: 6px 8px; }
  th.frozen, td.frozen { position: sticky; left: 0; background: #fafafa; z-index: 2; }
</style>
</head>
<body>
  <h3>Live Timeline</h3>
  <div id="timeline"></div>
  <h3>Progress</h3>
  <progress id="progress" value="0" max="100"></progress>
  <h3>Artifacts</h3>
  <div id="artifacts"></div>

  <h3>Build Controls</h3>
  <form id="f">
    <label>Project Path <input id="pp" style="width:360px" value="/path/to/UnityProject"/></label>
    <label>K8s Image <input id="img" value="alpine:3.19"/></label>
    <label>Artifact Server <input id="as" value="http://localhost:8089"/></label>
    <button type="submit">Run Unity→K8s</button>
  </form>

  <script type="module">
    import {UIDSLRuntime} from './runtime.js';
    const ui = new UIDSLRuntime(document.body, `ws://${location.host}/events?user=default`);
    document.getElementById("f").onsubmit = async (ev)=>{
      ev.preventDefault();
      const body = {
        kind: "unity_k8s",
        project_path: document.getElementById("pp").value,
        k8s_image: document.getElementById("img").value,
        artifact_server_url: document.getElementById("as").value,
        claims: {claims:[/* כאן אפשר לשים hashes של ראיות CAS תקפות */]}
      };
      const r = await fetch("/run_adapter?user=default&kind=unity_k8s", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
      const j = await r.json();
      console.log(j);
    };
  </script>
</body>
</html>

<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<title>IMU – Progress & Timeline</title>
<style>
body { font-family: system-ui, sans-serif; margin: 24px; }
#prog { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin-bottom: 16px; }
#bar { height: 100%; width: 0%; background: #4caf50; transition: width 200ms; }
#timeline { max-height: 50vh; overflow:auto; border:1px solid #ddd; padding:8px; }
.ev { border-bottom:1px dashed #ddd; padding:6px 0; }
.ev .k { color:#888; font-size:12px; }
</style>
</head>
<body>
<h1>IMU – Live Progress & Timeline</h1>
<div id="prog"><div id="bar"></div></div>
<div id="timeline"></div>

<script>
const bar = document.getElementById('bar');
const timeline = document.getElementById('timeline');
let pct = 0;

function addEv(obj){
  const div = document.createElement('div');
  div.className = 'ev';
  div.innerHTML = `<div class="k">${new Date().toLocaleTimeString()}</div><pre>${JSON.stringify(obj, null, 2)}</pre>`;
  timeline.prepend(div);
}

function bumpProgress(delta=3){
  pct = Math.min(100, pct + delta);
  bar.style.width = pct + '%';
}

const ws = new WebSocket(`ws://${location.hostname}:8080/ws`);
ws.onopen = () => addEv({kind:"ws_open"});
ws.onmessage = ev => {
  try {
    const obj = JSON.parse(ev.data);
    addEv(obj);
    if (obj.kind === 'capability_request') bumpProgress(5);
    if (obj.kind === 'adapter_dry_run') bumpProgress(2);
  } catch (e) {
    addEv({kind:"parse_error", msg:e.toString()});
  }
};
ws.onclose = () => addEv({kind:"ws_close"});

// דוגמת קריאה ל-HTTP לבקש יכולת (dry-run)
fetch('http://'+location.hostname+':8081/capabilities/request', {
  method: 'POST',
  headers: {'Content-Type':'application/json'},
  body: JSON.stringify({ name: "k8s_cli", dry_run: true, user_id:"demo", trust_level:2, allow_exec:false, allow_network:false })
}).then(r => r.json()).then(j => addEv({kind:"http_reply", j}));
</script>
</body>
</html>